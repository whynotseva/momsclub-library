# ТЗ: Личный кабинет + Оплата на сайте

**Версия:** 1.0  
**Дата:** 09.12.2024  
**Проект:** Mom's Club Library

---

## Цели

1. Создать полноценный личный кабинет пользователя на сайте/PWA
2. Дать возможность оплачивать подписку прямо на сайте
3. Разрешить доступ на сайт пользователям без подписки (только в ЛК)
4. Унифицировать опыт между ботом и сайтом

---

## Общий план

| Фаза | Описание | Время | Статус |
|------|----------|-------|--------|
| 1 | Авторизация и роутинг | 2-3 дня | ✅ 09.12 |
| 2 | Страница профиля | 3-4 дня | ⏳ |
| 3 | Модалка оплаты (фронт) | 2 дня | ⏳ |
| 4 | Бэкенд платежей + ЮКасса | 3-4 дня | ⏳ |
| 5 | Уведомления в бота | 1-2 дня | ⏳ |
| 6 | Тестирование | 2 дня | ⏳ |
| 7 | Деплой | 1 день | ⏳ |

---

# Фаза 1: Авторизация и роутинг

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 1.1 | Изменить бэкенд авторизации — не блокировать без подписки | ✅ |
| 1.2 | Добавить поле `has_active_subscription` в ответ `/auth/me` | ✅ (уже было) |
| 1.3 | Обновить `AuthContext` — хранить статус подписки | ✅ |
| 1.4 | Создать middleware/защиту роутов | ✅ SubscriptionGuard |
| 1.5 | Создать страницу `/profile` (заглушка) | ✅ |
| 1.6 | **ТЕСТ** | ✅ Деплой 09.12 |

## Логика доступа

```
Авторизация → Проверка подписки
                ├─ ЕСТЬ → Полный доступ (все страницы)
                └─ НЕТ → Только /profile
```

### Защищённые роуты:

| Роут | Без подписки | С подпиской |
|------|--------------|-------------|
| `/profile` | ✅ | ✅ |
| `/library` | ❌ → редирект /profile | ✅ |
| `/favorites` | ❌ → редирект /profile | ✅ |
| `/history` | ❌ → редирект /profile | ✅ |
| `/admin` | По правам админа | По правам админа |

---

# Фаза 2: Страница профиля

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 2.1 | Создать `ProfilePage.tsx` — основной layout | ⏳ |
| 2.2 | Компонент `ProfileHeader` — аватар, имя, бейджи | ⏳ |
| 2.3 | Компонент `SubscriptionCard` — статус подписки | ⏳ |
| 2.4 | Компонент `LoyaltyCard` — программа лояльности | ⏳ |
| 2.5 | Компонент `ReferralCard` — реферальная программа | ⏳ |
| 2.6 | Компонент `PaymentHistoryCard` — история платежей | ⏳ |
| 2.7 | Компонент `SettingsCard` — настройки (ДР, автопродление) | ⏳ |
| 2.8 | Адаптив для мобилки | ⏳ |
| 2.9 | **ТЕСТ** | ⏳ |

## Макет страницы

```
┌─────────────────────────────────────────────────────┐
│                 КАРТОЧКА ПРОФИЛЯ                    │
│  [Аватар]  Имя Фамилия                             │
│            @username                                │
│            💎 Platinum                              │
│            🏆 Бейджи: 🎖️🎖️🎖️                       │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    ПОДПИСКА                         │
│  ✅ Активна до: 15.03.2025 (95 дней)              │
│  🔄 Автопродление: Включено                        │
│  [Продлить заранее]                                │
└─────────────────────────────────────────────────────┘

┌────────────────────────┐ ┌────────────────────────┐
│  ЛОЯЛЬНОСТЬ            │ │  РЕФЕРАЛЫ              │
│  💎 Platinum           │ │  👥 5 приглашено       │
│  📅 380 дней в клубе   │ │  💰 1 500 ₽ заработано │
│  [Подробнее]           │ │  [Подробнее]           │
└────────────────────────┘ └────────────────────────┘

┌────────────────────────┐ ┌────────────────────────┐
│  ИСТОРИЯ ПЛАТЕЖЕЙ      │ │  НАСТРОЙКИ             │
│  [Посмотреть]          │ │  [Открыть]             │
└────────────────────────┘ └────────────────────────┘
```

## Вариант без подписки

```
┌─────────────────────────────────────────────────────┐
│                 КАРТОЧКА ПРОФИЛЯ                    │
│  [Аватар]  Имя Фамилия                             │
│            @username                                │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    ПОДПИСКА                         │
│  ❌ Нет активной подписки                          │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │           Оформить подписку                 │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

---

# Фаза 3: Модалка оплаты

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 3.1 | Компонент `TariffModal` — выбор тарифа | ⏳ |
| 3.2 | Логика расчёта цены (первая оплата, скидки лояльности) | ⏳ |
| 3.3 | Кнопка "Оплатить" → запрос к бэкенду | ⏳ |
| 3.4 | Ссылка "оплатить в боте" | ⏳ |
| 3.5 | Страница `/profile?payment=success` | ⏳ |
| 3.6 | **ТЕСТ** | ⏳ |

## Макет модалки

```
┌─────────────────────────────────────────────────────┐
│                  Выберите тариф                 ✕   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │  ○  1 месяц                                 │   │
│  │     990 ₽  (690 ₽ — первая оплата)         │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │  ●  2 месяца                      ХИТ 🔥   │   │
│  │     1 790 ₽  (экономия 190 ₽)              │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │  ○  3 месяца                                │   │
│  │     2 490 ₽  (экономия 480 ₽)              │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  💎 Ваша скидка Platinum: -15%                     │
│  Итого: 1 521 ₽                                    │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │              💳 Оплатить                    │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  или оплатить через бота →                         │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## Тарифы (из utils/constants.py)

| ID | Месяцев | Цена | Константа | Дней |
|----|---------|------|-----------|------|
| 1month | 1 | 990 ₽ | SUBSCRIPTION_PRICE | 30 |
| 1month_first | 1 | 690 ₽ | SUBSCRIPTION_PRICE_FIRST | 30 |
| 2months | 2 | 1 790 ₽ | SUBSCRIPTION_PRICE_2MONTHS | 60 |
| 3months | 3 | 2 490 ₽ | SUBSCRIPTION_PRICE_3MONTHS | 90 |

## Скидки лояльности (из loyalty/service.py)

| Уровень | Скидка | Дней в клубе |
|---------|--------|--------------|
| None | 0% | 0 |
| Silver | 5% | 90+ |
| Gold | 10% | 180+ |
| Platinum | 15% | 365+ |

## ⚠️ Определение первой оплаты

Первая оплата определяется по полю `user.is_first_payment_done`:
- Если `False` и сумма <= 690₽ → это первая оплата со скидкой
- После успешной оплаты устанавливается `is_first_payment_done = True`

---

# Фаза 4: Бэкенд платежей

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 4.1 | Скопировать ЮКасса credentials из бота в library_backend | ⏳ |
| 4.2 | Создать `yookassa_service.py` (переиспользовать код из `utils/payment.py`) | ⏳ |
| 4.3 | Эндпоинт `POST /api/payments/create` | ⏳ |
| 4.4 | Эндпоинт `POST /api/payments/webhook` | ⏳ |
| 4.5 | Эндпоинт `GET /api/payments/history` | ⏳ |
| 4.6 | Переиспользовать логику из `process_successful_payment()` | ⏳ |
| 4.7 | **ТЕСТ с тестовым магазином ЮКасса** | ⏳ |

## ⚠️ КРИТИЧНО: Защита от ошибок

### 1. Защита от дублирования платежей
```python
# PaymentLog.transaction_id — UNIQUE, NOT NULL (models.py:103)
# Если платёж с таким transaction_id уже есть — дубликат!

# Проверка в webhook (webhook_handlers.py:798-802):
if payment_log.status == "success" and payment_log.is_confirmed and payment_log.subscription_id:
    return  # Идемпотентность - не обрабатываем повторно
```

### 2. Логика создания/продления подписки
```python
# create_subscription() (crud.py:180-228):
# 1. Проверяет существующую активную подписку
# 2. Если есть — возвращает её (НЕ создаёт новую!)
# 3. Деактивирует ВСЕ старые подписки пользователя
# 4. Создаёт новую

# extend_subscription() (crud.py:272-353):
# 1. Получает активную подписку
# 2. Если есть — ПРОДЛЕВАЕТ (добавляет дни к end_date)
# 3. Если нет — создаёт новую через create_subscription()
```

### 3. Поля пользователя для оплаты
```python
# User модель (models.py):
yookassa_payment_method_id  # ID карты для автоплатежей
is_recurring_active         # Автопродление вкл/выкл
is_first_payment_done       # False = можно 690₽
first_payment_date          # Для расчёта стажа лояльности
current_loyalty_level       # none/silver/gold/platinum
```

### 4. Поля подписки
```python
# Subscription модель (models.py:62-89):
end_date                    # Дата окончания
is_active                   # Активна ли
renewal_price               # Цена автопродления
renewal_duration_days       # Дней автопродления
loyalty_applied_level       # Уровень лояльности при оплате
loyalty_discount_percent    # Скидка при оплате
```

---

## ⚠️ ВАЖНО: Существующий код бота

### Файлы для изучения/переиспользования:
- `utils/payment.py` — функция `create_payment_link()` создаёт платёж
- `handlers/webhook_handlers.py` — обработка webhook от ЮКасса
- `config.py` — credentials ЮКасса (YOOKASSA_SHOP_ID, YOOKASSA_SECRET_KEY)

### Функция `create_payment_link()` (utils/payment.py:121-218):
```python
# Что делает:
# 1. Генерирует payment_id (uuid4)
# 2. Создаёт payment_label = f"user_{user_id}_{sub_type}_{timestamp}_{random}"
# 3. Формирует metadata: telegram_id, sub_type, payment_label, days
# 4. Создаёт чек (receipt) для ЮКассы
# 5. Вызывает Payment.create() с save_payment_method=True (для автоплатежей)
# 6. Возвращает: (payment_url, payment.id, payment_label)
```

### Функция `process_successful_payment()` (webhook_handlers.py:196-592):
```python
# Что делает:
# 1. Получает пользователя из БД
# 2. Создаёт/продлевает подписку (create_subscription / extend_subscription)
# 3. Устанавливает is_first_payment_done если первая оплата
# 4. Устанавливает first_payment_date для лояльности
# 5. Сохраняет payment_method_id для автоплатежей
# 6. Обрабатывает реферальную систему (выбор награды рефереру)
# 7. Уведомление админам (send_payment_notification_to_admins)
# 8. Уведомление пользователю (send_payment_success_notification)
# 9. Проверяет бонус за автопродление (streak bonus)
# 10. Выдаёт badges (check_and_grant_badges)
```

### Метаданные платежа (metadata):
```python
metadata = {
    "telegram_id": str(user_id),  # ВАЖНО: telegram_id, не user_id!
    "sub_type": sub_type,         # "1month", "2months", "3months"
    "payment_label": payment_label,
    "days": str(days),            # 30, 60, 90
    "source": "website"           # ДОБАВИТЬ: чтобы различать оплаты с сайта
}
```

## 🏗️ Архитектурное решение: Webhook

### Вариант А: Новый webhook в library_backend (рекомендуется)
```
Сайт → library_backend → ЮКасса
                      ← webhook (новый URL)
                      → Уведомления в бота
```
**+** Полный контроль
**+** Логика в одном месте
**−** Дублирование кода

### Вариант Б: Переиспользовать webhook бота
```
Сайт → library_backend → ЮКасса
                      ← webhook (существующий: momsclubwebhook.ru:8000)
                      ← Бот обрабатывает и уведомляет
```
**+** Не дублируем логику
**−** Нужно добавить поле `source` в metadata чтобы различать

### Решение: Вариант Б (переиспользуем)
1. Создаём платёж через library_backend с `metadata.source = "website"`
2. Webhook идёт на существующий `momsclubwebhook.ru:8000`
3. В `process_successful_payment()` добавляем проверку `source`
4. Уведомление в бота работает как обычно

## API эндпоинты

### POST /api/payments/create

**Request:**
```json
{
  "tariff_id": "2months"
}
```

**Response:**
```json
{
  "payment_id": "2a3b4c5d-...",
  "confirmation_url": "https://yookassa.ru/payments/...",
  "amount": 1521,
  "original_amount": 1790,
  "discount": 269,
  "description": "Подписка Mom's Club — 2 месяца"
}
```

### POST /api/payments/webhook

Принимает webhook от ЮКасса при успешной оплате.

**Действия:**
1. Проверить подпись
2. Найти платёж в БД
3. Обновить статус → succeeded
4. Продлить/создать подписку
5. Отправить уведомления (Фаза 5)

### GET /api/payments/history

**Response:**
```json
{
  "payments": [
    {
      "id": "...",
      "date": "2024-12-09T15:30:00Z",
      "amount": 990,
      "tariff": "1 месяц",
      "status": "succeeded",
      "source": "website"
    }
  ]
}
```

---

# Фаза 5: Уведомления в бота

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 5.1 | Создать `notification_service.py` в library_backend | ⏳ |
| 5.2 | Добавить эндпоинт в боте для приёма уведомлений | ⏳ |
| 5.3 | Уведомление пользователю об успешной оплате | ⏳ |
| 5.4 | Уведомление админам о новой оплате | ⏳ |
| 5.5 | **ТЕСТ** | ⏳ |

## Уведомление пользователю

```
🎉 Оплата прошла успешно!

Спасибо за оплату подписки Mom's Club!

📦 Тариф: 2 месяца
💳 Сумма: 1 521 ₽ (скидка 15%)
📅 Подписка активна до: 15.02.2025
🌐 Способ оплаты: сайт

[🔐 Войти в Mom's Club]
[📚 Открыть библиотеку]
```

## Уведомление админам

```
💰 Новая оплата через сайт!

👤 Имя (@username)
📦 Тариф: 2 месяца
💳 Сумма: 1 521 ₽
💎 Уровень: Platinum (скидка 15%)
📅 Подписка до: 15.02.2025
```

---

# Фаза 6: Тестирование

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 6.1 | Тест авторизации без подписки | ⏳ |
| 6.2 | Тест ограничения доступа к библиотеке | ⏳ |
| 6.3 | Тест оплаты (тестовый режим ЮКасса) | ⏳ |
| 6.4 | Тест webhook | ⏳ |
| 6.5 | Тест уведомлений в бота | ⏳ |
| 6.6 | Тест на мобилке | ⏳ |
| 6.7 | Тест в PWA режиме | ⏳ |

---

# Фаза 7: Деплой

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 7.1 | Деплой бэкенда с новыми эндпоинтами | ⏳ |
| 7.2 | Деплой фронтенда | ⏳ |
| 7.3 | Настроить webhook URL в ЮКасса (боевой) | ⏳ |
| 7.4 | Добавить эндпоинт уведомлений в бота | ⏳ |
| 7.5 | Боевое тестирование (реальная оплата 1₽) | ⏳ |
| 7.6 | **РЕЛИЗ** | ⏳ |

---

# Обновление главной страницы

## Карточка профиля — изменения

**Было:**
- Кнопка "Продлить подписку"

**Стало:**
- Кнопка "Личный кабинет"
- Показываем: статус, дней осталось

---

# Файлы для создания/изменения

## Frontend

| Файл | Действие |
|------|----------|
| `app/profile/page.tsx` | Создать |
| `components/profile/ProfilePage.tsx` | Создать |
| `components/profile/ProfileHeader.tsx` | Создать |
| `components/profile/SubscriptionCard.tsx` | Создать |
| `components/profile/LoyaltyCard.tsx` | Создать |
| `components/profile/ReferralCard.tsx` | Создать |
| `components/profile/PaymentHistoryCard.tsx` | Создать |
| `components/profile/SettingsCard.tsx` | Создать |
| `components/profile/TariffModal.tsx` | Создать |
| `contexts/AuthContext.tsx` | Изменить |
| `middleware.ts` | Изменить |
| `components/home/WelcomeCard.tsx` | Изменить |

## Backend (library_backend)

| Файл | Действие |
|------|----------|
| `app/api/payments.py` | Создать |
| `app/services/payment_service.py` | Создать |
| `app/services/yookassa_service.py` | Создать |
| `app/services/notification_service.py` | Создать |
| `app/api/auth.py` | Изменить |
| `app/config.py` | Изменить (добавить ЮКасса) |

## Bot (handlers)

| Файл | Действие |
|------|----------|
| `handlers/webhook_handlers.py` | Изменить (добавить эндпоинт) |

---

# ⛔ ЧЕГО НЕ ДЕЛАТЬ (предотвращение ошибок)

1. **НЕ создавать новую подписку если активная уже есть** — только продлевать
2. **НЕ обрабатывать webhook повторно** — проверять `is_confirmed`
3. **НЕ дублировать transaction_id** — это UNIQUE поле
4. **НЕ менять логику has_active_subscription** — от неё зависит много кода
5. **НЕ забывать про автопродление** — сохранять `payment_method_id`
6. **НЕ игнорировать first_payment_date** — от неё считается лояльность
7. **НЕ путать telegram_id и user_id** — в metadata всегда telegram_id!

---

# Критерии готовности

- [ ] Пользователь без подписки видит только профиль
- [ ] Пользователь может выбрать тариф
- [ ] Пользователь может оплатить на сайте через ЮКасса
- [ ] После оплаты подписка активируется автоматически
- [ ] Пользователь получает уведомление в Telegram
- [ ] Админы получают уведомление в Telegram
- [ ] Работает продление (для тех у кого уже есть подписка)
- [ ] НЕ создаются дубликаты подписок
- [ ] НЕ ломается автопродление
- [ ] Работает на десктопе, мобилке, PWA
