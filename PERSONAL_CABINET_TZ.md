# ТЗ: Личный кабинет + Оплата на сайте

**Версия:** 1.0  
**Дата:** 09.12.2024  
**Проект:** Mom's Club Library

---

## Цели

1. Создать полноценный личный кабинет пользователя на сайте/PWA
2. Дать возможность оплачивать подписку прямо на сайте
3. Разрешить доступ на сайт пользователям без подписки (только в ЛК)
4. Унифицировать опыт между ботом и сайтом

---

## Общий план

| Фаза | Описание | Время | Статус |
|------|----------|-------|--------|
| 1 | Авторизация и роутинг | 2-3 дня | ⏳ |
| 2 | Страница профиля | 3-4 дня | ⏳ |
| 3 | Модалка оплаты (фронт) | 2 дня | ⏳ |
| 4 | Бэкенд платежей + ЮКасса | 3-4 дня | ⏳ |
| 5 | Уведомления в бота | 1-2 дня | ⏳ |
| 6 | Тестирование | 2 дня | ⏳ |
| 7 | Деплой | 1 день | ⏳ |

---

# Фаза 1: Авторизация и роутинг

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 1.1 | Изменить бэкенд авторизации — не блокировать без подписки | ⏳ |
| 1.2 | Добавить поле `has_active_subscription` в ответ `/auth/me` | ⏳ |
| 1.3 | Обновить `AuthContext` — хранить статус подписки | ⏳ |
| 1.4 | Создать middleware/защиту роутов | ⏳ |
| 1.5 | Создать страницу `/profile` (заглушка) | ⏳ |
| 1.6 | **ТЕСТ** | ⏳ |

## Логика доступа

```
Авторизация → Проверка подписки
                ├─ ЕСТЬ → Полный доступ (все страницы)
                └─ НЕТ → Только /profile
```

### Защищённые роуты:

| Роут | Без подписки | С подпиской |
|------|--------------|-------------|
| `/profile` | ✅ | ✅ |
| `/library` | ❌ → редирект /profile | ✅ |
| `/favorites` | ❌ → редирект /profile | ✅ |
| `/history` | ❌ → редирект /profile | ✅ |
| `/admin` | По правам админа | По правам админа |

---

# Фаза 2: Страница профиля

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 2.1 | Создать `ProfilePage.tsx` — основной layout | ⏳ |
| 2.2 | Компонент `ProfileHeader` — аватар, имя, бейджи | ⏳ |
| 2.3 | Компонент `SubscriptionCard` — статус подписки | ⏳ |
| 2.4 | Компонент `LoyaltyCard` — программа лояльности | ⏳ |
| 2.5 | Компонент `ReferralCard` — реферальная программа | ⏳ |
| 2.6 | Компонент `PaymentHistoryCard` — история платежей | ⏳ |
| 2.7 | Компонент `SettingsCard` — настройки (ДР, автопродление) | ⏳ |
| 2.8 | Адаптив для мобилки | ⏳ |
| 2.9 | **ТЕСТ** | ⏳ |

## Макет страницы

```
┌─────────────────────────────────────────────────────┐
│                 КАРТОЧКА ПРОФИЛЯ                    │
│  [Аватар]  Имя Фамилия                             │
│            @username                                │
│            💎 Platinum                              │
│            🏆 Бейджи: 🎖️🎖️🎖️                       │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    ПОДПИСКА                         │
│  ✅ Активна до: 15.03.2025 (95 дней)              │
│  🔄 Автопродление: Включено                        │
│  [Продлить заранее]                                │
└─────────────────────────────────────────────────────┘

┌────────────────────────┐ ┌────────────────────────┐
│  ЛОЯЛЬНОСТЬ            │ │  РЕФЕРАЛЫ              │
│  💎 Platinum           │ │  👥 5 приглашено       │
│  📅 380 дней в клубе   │ │  💰 1 500 ₽ заработано │
│  [Подробнее]           │ │  [Подробнее]           │
└────────────────────────┘ └────────────────────────┘

┌────────────────────────┐ ┌────────────────────────┐
│  ИСТОРИЯ ПЛАТЕЖЕЙ      │ │  НАСТРОЙКИ             │
│  [Посмотреть]          │ │  [Открыть]             │
└────────────────────────┘ └────────────────────────┘
```

## Вариант без подписки

```
┌─────────────────────────────────────────────────────┐
│                 КАРТОЧКА ПРОФИЛЯ                    │
│  [Аватар]  Имя Фамилия                             │
│            @username                                │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    ПОДПИСКА                         │
│  ❌ Нет активной подписки                          │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │           Оформить подписку                 │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

---

# Фаза 3: Модалка оплаты

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 3.1 | Компонент `TariffModal` — выбор тарифа | ⏳ |
| 3.2 | Логика расчёта цены (первая оплата, скидки лояльности) | ⏳ |
| 3.3 | Кнопка "Оплатить" → запрос к бэкенду | ⏳ |
| 3.4 | Ссылка "оплатить в боте" | ⏳ |
| 3.5 | Страница `/profile?payment=success` | ⏳ |
| 3.6 | **ТЕСТ** | ⏳ |

## Макет модалки

```
┌─────────────────────────────────────────────────────┐
│                  Выберите тариф                 ✕   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │  ○  1 месяц                                 │   │
│  │     990 ₽  (690 ₽ — первая оплата)         │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │  ●  2 месяца                      ХИТ 🔥   │   │
│  │     1 790 ₽  (экономия 190 ₽)              │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │  ○  3 месяца                                │   │
│  │     2 490 ₽  (экономия 480 ₽)              │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  💎 Ваша скидка Platinum: -15%                     │
│  Итого: 1 521 ₽                                    │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │              💳 Оплатить                    │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  или оплатить через бота →                         │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## Тарифы

| ID | Месяцев | Цена | Первая оплата | Экономия |
|----|---------|------|---------------|----------|
| 1month | 1 | 990 ₽ | 690 ₽ | — |
| 2months | 2 | 1 790 ₽ | — | 190 ₽ |
| 3months | 3 | 2 490 ₽ | — | 480 ₽ |

## Скидки лояльности

| Уровень | Скидка |
|---------|--------|
| None | 0% |
| Silver | 5% |
| Gold | 10% |
| Platinum | 15% |

---

# Фаза 4: Бэкенд платежей

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 4.1 | Настроить ЮКасса credentials в config | ⏳ |
| 4.2 | Создать `yookassa_service.py` — работа с API | ⏳ |
| 4.3 | Эндпоинт `POST /api/payments/create` | ⏳ |
| 4.4 | Эндпоинт `POST /api/payments/webhook` | ⏳ |
| 4.5 | Эндпоинт `GET /api/payments/history` | ⏳ |
| 4.6 | Логика продления подписки | ⏳ |
| 4.7 | **ТЕСТ с тестовым магазином ЮКасса** | ⏳ |

## API эндпоинты

### POST /api/payments/create

**Request:**
```json
{
  "tariff_id": "2months"
}
```

**Response:**
```json
{
  "payment_id": "2a3b4c5d-...",
  "confirmation_url": "https://yookassa.ru/payments/...",
  "amount": 1521,
  "original_amount": 1790,
  "discount": 269,
  "description": "Подписка Mom's Club — 2 месяца"
}
```

### POST /api/payments/webhook

Принимает webhook от ЮКасса при успешной оплате.

**Действия:**
1. Проверить подпись
2. Найти платёж в БД
3. Обновить статус → succeeded
4. Продлить/создать подписку
5. Отправить уведомления (Фаза 5)

### GET /api/payments/history

**Response:**
```json
{
  "payments": [
    {
      "id": "...",
      "date": "2024-12-09T15:30:00Z",
      "amount": 990,
      "tariff": "1 месяц",
      "status": "succeeded",
      "source": "website"
    }
  ]
}
```

---

# Фаза 5: Уведомления в бота

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 5.1 | Создать `notification_service.py` в library_backend | ⏳ |
| 5.2 | Добавить эндпоинт в боте для приёма уведомлений | ⏳ |
| 5.3 | Уведомление пользователю об успешной оплате | ⏳ |
| 5.4 | Уведомление админам о новой оплате | ⏳ |
| 5.5 | **ТЕСТ** | ⏳ |

## Уведомление пользователю

```
🎉 Оплата прошла успешно!

Спасибо за оплату подписки Mom's Club!

📦 Тариф: 2 месяца
💳 Сумма: 1 521 ₽ (скидка 15%)
📅 Подписка активна до: 15.02.2025
🌐 Способ оплаты: сайт

[🔐 Войти в Mom's Club]
[📚 Открыть библиотеку]
```

## Уведомление админам

```
💰 Новая оплата через сайт!

👤 Имя (@username)
📦 Тариф: 2 месяца
💳 Сумма: 1 521 ₽
💎 Уровень: Platinum (скидка 15%)
📅 Подписка до: 15.02.2025
```

---

# Фаза 6: Тестирование

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 6.1 | Тест авторизации без подписки | ⏳ |
| 6.2 | Тест ограничения доступа к библиотеке | ⏳ |
| 6.3 | Тест оплаты (тестовый режим ЮКасса) | ⏳ |
| 6.4 | Тест webhook | ⏳ |
| 6.5 | Тест уведомлений в бота | ⏳ |
| 6.6 | Тест на мобилке | ⏳ |
| 6.7 | Тест в PWA режиме | ⏳ |

---

# Фаза 7: Деплой

## Задачи

| # | Задача | Статус |
|---|--------|--------|
| 7.1 | Деплой бэкенда с новыми эндпоинтами | ⏳ |
| 7.2 | Деплой фронтенда | ⏳ |
| 7.3 | Настроить webhook URL в ЮКасса (боевой) | ⏳ |
| 7.4 | Добавить эндпоинт уведомлений в бота | ⏳ |
| 7.5 | Боевое тестирование (реальная оплата 1₽) | ⏳ |
| 7.6 | **РЕЛИЗ** | ⏳ |

---

# Обновление главной страницы

## Карточка профиля — изменения

**Было:**
- Кнопка "Продлить подписку"

**Стало:**
- Кнопка "Личный кабинет"
- Показываем: статус, дней осталось

---

# Файлы для создания/изменения

## Frontend

| Файл | Действие |
|------|----------|
| `app/profile/page.tsx` | Создать |
| `components/profile/ProfilePage.tsx` | Создать |
| `components/profile/ProfileHeader.tsx` | Создать |
| `components/profile/SubscriptionCard.tsx` | Создать |
| `components/profile/LoyaltyCard.tsx` | Создать |
| `components/profile/ReferralCard.tsx` | Создать |
| `components/profile/PaymentHistoryCard.tsx` | Создать |
| `components/profile/SettingsCard.tsx` | Создать |
| `components/profile/TariffModal.tsx` | Создать |
| `contexts/AuthContext.tsx` | Изменить |
| `middleware.ts` | Изменить |
| `components/home/WelcomeCard.tsx` | Изменить |

## Backend (library_backend)

| Файл | Действие |
|------|----------|
| `app/api/payments.py` | Создать |
| `app/services/payment_service.py` | Создать |
| `app/services/yookassa_service.py` | Создать |
| `app/services/notification_service.py` | Создать |
| `app/api/auth.py` | Изменить |
| `app/config.py` | Изменить (добавить ЮКасса) |

## Bot (handlers)

| Файл | Действие |
|------|----------|
| `handlers/webhook_handlers.py` | Изменить (добавить эндпоинт) |

---

# Критерии готовности

- [ ] Пользователь без подписки видит только профиль
- [ ] Пользователь может выбрать тариф
- [ ] Пользователь может оплатить на сайте через ЮКасса
- [ ] После оплаты подписка активируется автоматически
- [ ] Пользователь получает уведомление в Telegram
- [ ] Админы получают уведомление в Telegram
- [ ] Работает продление (для тех у кого уже есть подписка)
- [ ] Работает на десктопе, мобилке, PWA
