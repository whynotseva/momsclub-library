#!/usr/bin/env python3
"""
–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
"""

import asyncio
import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from aiogram import Bot
from aiogram.types import FSInputFile, InlineKeyboardMarkup, InlineKeyboardButton
from config import BOT_TOKEN

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=BOT_TOKEN)

# –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
BROADCAST_IMAGE_PATH = os.path.join("media", "—Å–µ–Ω—Ç—è–±—Ä—å—Ä–∞—Å—Å—ã–ª–∫–∞.PNG")

# –¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º  
BROADCAST_TEXT = """–Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω –æ—Å–µ–Ω—å üçÇ 
welcome, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ <b>–°–ï–ù–¢–Ø–ë–†–¨</b> üß∫üß∏

<i>*–≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –≤—Å–µ —Ç–µ–º—ã –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–µ—Å—è—Ü–∞ (–∞ –∏—Ö —Ç–∞–º –æ—á–µ–Ω—å –º–Ω–æ–≥–æ)</i>

ü§© —Å–µ–Ω—Ç—è–±—Ä—å –±—É–¥–µ—Ç –æ—á–µ–Ω—å –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º, –ø–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∞—Å –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∫–ª—É–±–∞, –≤–∞—Å –∂–¥–µ—Ç:

‚Äî –Ω–æ–≤—ã–π <b>CHALLENGE</b> –∏ –æ–Ω –±—É–¥–µ—Ç –ø–æ —Å—Ç–æ—Ä–∏—Å > —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ & –Ω–µ–±–æ–ª—å—à–∏–º–∏ —Ä–∞–∑–±–æ—Ä–∞–º–∏ > –ø–æ–≤—ã—à–∞–µ–º –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏ ü´Ç

‚Äî <b>–ò–î–ï–ò –î–õ–Ø –ö–û–ù–¢–ï–ù–¢–ê</b> > –º—É–¥–±–æ—Ä–¥—ã & —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã –¥–ª—è –≤–∞—à–∏—Ö —Å—ä–µ–º–æ–∫ (—Å–æ–∑–¥–∞–¥–∏–º —ç—Å—Ç–µ—Ç–∏–∫—É –≤ —ç—Ç–æ–º —Å–µ–∑–æ–Ω–µ üß∫)

<blockquote>üåü –∞ —Ç–∞–∫ –∂–µ —Ä–∞–∑–±–æ—Ä—ã –≤–∞—à–∏—Ö —Å—ä–µ–º–æ–∫ ‚Äî —Å–æ–∑–¥–∞–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞–º & –ø–æ–ª—É—á–∞–π –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å (—ç—Ç–æ —á—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-–º–∞—Ä–∞—Ñ–æ–Ω? ü•π)</blockquote>

‚Äî –≤–∞–∂–Ω—ã–µ –ø–æ–¥–∫–∞—Å—Ç—ã –æ –Ω–æ–≤–æ–π —ç—Ä–µ –≤ –∏–Ω—Å—Ç > –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –≤–µ—Å—Ç–∏ –±–ª–æ–≥? –∏ –ø–æ–ª–µ–∑–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ ü§åüèº

–±–µ–∑—É—Å–ª–æ–≤–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–¥–µ–π –¥–ª—è –≤–∞—à–∏—Ö —Ä–∏–ª—Å –∏ –ø–æ—Å—Ç–æ–≤ & –æ–≥—Ä–æ–º–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç <a href="tg://resolve?domain=polinadmitrenkoo">@polinadmitrenkoo</a> –∏ <a href="tg://resolve?domain=OlyaGrishina92">@OlyaGrishina92</a> ü§éüß∫üçÇ

<u>–ì–æ—Ç–æ–≤—ã –∫ –Ω–æ–≤–æ–º—É —Å–µ–∑–æ–Ω—É?</u>"""

async def test_broadcast_message(user_id: int):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    
    Args:
        user_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    try:
        print(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}...")
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–í—Å—Ç—É–ø–∏—Ç—å"
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text="üíì –í—Å—Ç—É–ø–∏—Ç—å", callback_data="subscribe")]
            ]
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if os.path.exists(BROADCAST_IMAGE_PATH):
            print(f"üñºÔ∏è –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º: {BROADCAST_IMAGE_PATH}")
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º
            photo = FSInputFile(BROADCAST_IMAGE_PATH)
            await bot.send_photo(
                chat_id=user_id,
                photo=photo,
                caption=BROADCAST_TEXT,
                reply_markup=keyboard,
                parse_mode="HTML"
            )
        else:
            print(f"‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {BROADCAST_IMAGE_PATH} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç")
            # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
            await bot.send_message(
                chat_id=user_id,
                text=BROADCAST_TEXT,
                reply_markup=keyboard,
                parse_mode="HTML"
            )
        
        print("‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")
        return False

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ê–°–°–´–õ–ö–ò –ú–û–ú'–° –ö–õ–£–ë")
    print("=" * 50)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    if not BOT_TOKEN:
        print("‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
        return
    
    print("‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    if not os.path.exists(BROADCAST_IMAGE_PATH):
        print(f"‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: {BROADCAST_IMAGE_PATH}")
        print("–†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–º")
    else:
        print("‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞–π–¥–µ–Ω–æ")
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º Telegram ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    print(f"\nüìù –¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ ({len(BROADCAST_TEXT)} —Å–∏–º–≤–æ–ª–æ–≤):")
    print("-" * 30)
    print(BROADCAST_TEXT[:200] + "..." if len(BROADCAST_TEXT) > 200 else BROADCAST_TEXT)
    print("-" * 30)
    
    while True:
        user_id_input = input(f"\nüë§ –í–≤–µ–¥–∏—Ç–µ Telegram ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞): ").strip()
        
        if user_id_input.lower() == 'q':
            print("‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")
            return
        
        try:
            user_id = int(user_id_input)
            break
        except ValueError:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    success = await test_broadcast_message(user_id)
    
    if success:
        print(f"\nüéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        print(f"‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        print(f"üì± –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
    else:
        print(f"\n‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª")
        print(f"üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å Telegram ID –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–æ—Ç–∞")

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
