# ğŸ¯ Ğ Ğ•Ğ¤Ğ•Ğ ĞĞ›Ğ¬ĞĞĞ¯ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ 2.0 - ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ§Ğ˜Ğ¡Ğ¢ĞĞ“Ğ ĞšĞĞ”Ğ

## ğŸ“ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ ĞĞ«Ğ• ĞŸĞ Ğ˜ĞĞ¦Ğ˜ĞŸĞ«

### âœ… Ğ“Ğ›ĞĞ’ĞĞĞ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ: Ğ ĞĞ—Ğ”Ğ•Ğ›Ğ¯Ğ™ Ğ˜ Ğ’Ğ›ĞĞ¡Ğ¢Ğ’Ğ£Ğ™!

**ĞĞ• Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸!**
- ĞĞ´Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ = Ğ¾Ğ´Ğ½Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°
- ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 50 ÑÑ‚Ñ€Ğ¾Ğº Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
- Ğ•ÑĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ â†’ Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° Ğ¿Ğ¾Ğ´Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸

---

## ğŸ—‚ï¸ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ ĞœĞĞ”Ğ£Ğ›Ğ•Ğ™

### 1. **database/crud.py** - Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ‘Ğ”

**Ğ¥ĞĞ ĞĞ¨Ğ:**
```python
async def add_referral_balance(session, user_id, amount):
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑÑ€ĞµĞ´ÑÑ‚Ğ²Ğ° Ğ½Ğ° Ğ±Ğ°Ğ»Ğ°Ğ½Ñ"""
    # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ‘Ğ”, Ğ½Ğ¸ĞºĞ°ĞºĞ¾Ğ¹ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸!
    query = update(User).where(...).values(...)
    await session.execute(query)
    await session.commit()
    return True

async def get_referral_balance(session, user_id):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    user = await get_user_by_id(session, user_id)
    return user.referral_balance if user else 0
```

**ĞŸĞ›ĞĞ¥Ğ:**
```python
async def add_referral_balance(session, user_id, amount):
    # âŒ ĞĞ• Ğ¡ĞœĞ•Ğ¨Ğ˜Ğ’ĞĞ¢Ğ¬ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸, ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¸ Ğ‘Ğ”!
    if amount < 0:
        raise ValueError("...")
    user = await get_user_by_id(...)
    # ... ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
    # ... Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
    # Ğ­Ñ‚Ğ¾ Ğ²ÑÑ‘ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑÑ…!
```

---

### 2. **utils/referral_helpers.py** (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›!)

**Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²:**

```python
"""
Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ, Ğ½Ğµ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½ÑƒÑ Ñ Ğ‘Ğ” Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
"""

def calculate_referral_bonus(payment_amount: int, loyalty_level: str) -> int:
    """Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ±Ğ¾Ğ½ÑƒÑĞ°"""
    from utils.constants import REFERRAL_MONEY_PERCENT
    bonus_percent = REFERRAL_MONEY_PERCENT.get(loyalty_level, 10)
    return int(payment_amount * bonus_percent / 100)

def format_balance_text(balance: int) -> str:
    """Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ"""
    return f"{balance:,}â‚½"

def mask_card_number(card_number: str) -> str:
    """ĞœĞ°ÑĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ñ‹"""
    return f"{card_number[:4]} **** **** {card_number[-4:]}"

def validate_card_number(card_number: str) -> tuple[bool, str]:
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ñ‹"""
    cleaned = card_number.strip().replace(" ", "")
    if not cleaned.isdigit():
        return False, "ĞĞ¾Ğ¼ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹"
    if len(cleaned) != 16:
        return False, "ĞĞ¾Ğ¼ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ 16 Ñ†Ğ¸Ñ„Ñ€"
    return True, ""

def validate_phone_number(phone: str) -> tuple[bool, str]:
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ´Ğ»Ñ Ğ¡Ğ‘ĞŸ"""
    cleaned = phone.strip().replace("+", "").replace(" ", "").replace("-", "")
    if not cleaned.isdigit():
        return False, "ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹"
    if len(cleaned) != 11:
        return False, "ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ 11 Ñ†Ğ¸Ñ„Ñ€"
    return True, ""

def get_loyalty_emoji(loyalty_level: str) -> str:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ´Ğ»Ñ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸"""
    return {
        'none': 'ğŸ¤',
        'silver': 'ğŸ¥ˆ',
        'gold': 'ğŸ¥‡',
        'platinum': 'ğŸ’'
    }.get(loyalty_level, 'ğŸ¤')

def get_loyalty_name(loyalty_level: str) -> str:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸"""
    return {
        'none': 'Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº',
        'silver': 'Silver',
        'gold': 'Gold',
        'platinum': 'Platinum'
    }.get(loyalty_level, 'Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº')
```

---

### 3. **utils/referral_messages.py** (ĞĞĞ’Ğ«Ğ™ Ğ¤ĞĞ™Ğ›!)

**Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:**

```python
"""
Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
Ğ’ÑĞµ Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ Ğ´Ğ»Ñ Ğ»ĞµĞ³ĞºĞ¾Ğ³Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
"""

def get_reward_choice_text(referee_name: str, money_amount: int, bonus_percent: int, loyalty_emoji: str, can_get_money: bool) -> str:
    """Ğ¢ĞµĞºÑÑ‚ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹"""
    text = (
        f"ğŸ <b>ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸!</b>\n\n"
        f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {referee_name} Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ» Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ!\n\n"
        f"ğŸ’° <b>Ğ’Ğ°Ñˆ Ğ±Ğ¾Ğ½ÑƒÑ:</b> {money_amount:,}â‚½ ({bonus_percent}% {loyalty_emoji})\n\n"
        f"Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñƒ:"
    )
    
    if not can_get_money:
        text += "\n\nâš ï¸ <i>Ğ”ĞµĞ½ĞµĞ¶Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹</i>"
    
    return text

def get_money_reward_success_text(amount: int, new_balance: int) -> str:
    """Ğ¢ĞµĞºÑÑ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ Ğ´ĞµĞ½ĞµĞ³"""
    return (
        f"âœ… <b>Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾!</b>\n\n"
        f"ğŸ’° +{amount:,}â‚½ Ğ½Ğ° Ğ²Ğ°Ñˆ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ\n\n"
        f"ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {new_balance:,}â‚½\n\n"
        f"Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ñ‚ 500â‚½ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ñƒ!"
    )

def get_days_reward_success_text(days: int, end_date: str) -> str:
    """Ğ¢ĞµĞºÑÑ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ Ğ´Ğ½ĞµĞ¹"""
    return (
        f"âœ… <b>Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾!</b>\n\n"
        f"ğŸ“… +{days} Ğ´Ğ½ĞµĞ¹ Ğº Ğ²Ğ°ÑˆĞµĞ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ\n\n"
        f"ğŸ—“ ĞĞ¾Ğ²Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ: {end_date}\n\n"
        f"Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° ÑƒÑ‡Ğ°ÑÑ‚Ğ¸Ğµ Ğ² Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğµ! ğŸ’–"
    )

def get_withdrawal_request_created_text(amount: int, payment_details: str) -> str:
    """Ğ¢ĞµĞºÑÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ½Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´"""
    return (
        f"âœ… <b>Ğ—Ğ°ÑĞ²ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!</b>\n\n"
        f"ğŸ’° Ğ¡ÑƒĞ¼Ğ¼Ğ°: {amount:,}â‚½\n"
        f"ğŸ“‡ Ğ ĞµĞºĞ²Ğ¸Ğ·Ğ¸Ñ‚Ñ‹: {payment_details}\n\n"
        f"ğŸ“‹ Ğ’Ğ°ÑˆĞ° Ğ·Ğ°ÑĞ²ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ†Ğ¸Ñ.\n"
        f"ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ ĞµÑ‘ Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ 24 Ñ‡Ğ°ÑĞ¾Ğ².\n\n"
        f"Ğ’Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğµ! ğŸ’Œ"
    )

# Ğ˜ Ñ‚Ğ°Ğº Ğ´Ğ°Ğ»ĞµĞµ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²...
```

---

### 4. **handlers/** - Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

**Ğ¥ĞĞ ĞĞ¨Ğ:**
```python
@user_router.callback_query(F.data.startswith("ref_reward_money:"))
async def process_referral_reward_money(callback: types.CallbackQuery):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ´ĞµĞ½ĞµĞ¶Ğ½Ğ¾Ğ¹ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹"""
    # 1. ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
    referee_id = int(callback.data.split(":")[1])
    
    # 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ‘Ğ” (Ñ‡ĞµÑ€ĞµĞ· CRUD)
    async with AsyncSessionLocal() as session:
        referrer = await get_user_by_telegram_id(session, callback.from_user.id)
        referee = await get_user_by_id(session, referee_id)
        
        # 3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ (Ğ¸Ğ· helpers)
        result = await process_money_reward(session, referrer, referee)
        
        # 4. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ (Ğ¸Ğ· messages)
        if result.success:
            text = get_money_reward_success_text(result.amount, result.new_balance)
            await callback.message.edit_text(text, parse_mode="HTML")
        else:
            await callback.answer(result.error_message, show_alert=True)
```

**ĞŸĞ›ĞĞ¥Ğ:**
```python
@user_router.callback_query(F.data.startswith("ref_reward_money:"))
async def process_referral_reward_money(callback: types.CallbackQuery):
    # âŒ ĞĞ• ĞŸĞ˜Ğ¡ĞĞ¢Ğ¬ Ğ’Ğ¡Ğ® Ğ›ĞĞ“Ğ˜ĞšĞ£ Ğ—Ğ”Ğ•Ğ¡Ğ¬!
    # âŒ 200 ÑÑ‚Ñ€Ğ¾Ğº ĞºĞ¾Ğ´Ğ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞµ = Ğ¿Ğ»Ğ¾Ñ…Ğ¾
    # âŒ SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ = Ğ¿Ğ»Ğ¾Ñ…Ğ¾
    # âŒ Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞµ = Ğ¿Ğ»Ğ¾Ñ…Ğ¾
    pass
```

---

## ğŸ—ï¸ Ğ¡Ğ›ĞĞ˜ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  handlers/ (ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹)    â”‚  â† Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ routing Ğ¸ UI
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  utils/*_helpers.py (Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°) â”‚  â† Ğ Ğ°ÑÑ‡ĞµÑ‚Ñ‹, Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  utils/*_messages.py (Ğ¢ĞµĞºÑÑ‚Ñ‹)       â”‚  â† Ğ’ÑĞµ Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ¿ÑƒÑˆĞµĞ¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  database/crud.py (Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ‘Ğ”)     â”‚  â† Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  database/models.py (ĞœĞ¾Ğ´ĞµĞ»Ğ¸)        â”‚  â† Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ‘Ğ”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Ğ§Ğ•ĞšĞ›Ğ˜Ğ¡Ğ¢ Ğ§Ğ˜Ğ¡Ğ¢ĞĞ“Ğ ĞšĞĞ”Ğ

### ĞŸĞµÑ€ĞµĞ´ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ:

- [ ] **Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ < 50 ÑÑ‚Ñ€Ğ¾Ğº?**
  - Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ â†’ Ñ€Ğ°Ğ·Ğ±ĞµĞ¹ Ğ½Ğ° Ğ¿Ğ¾Ğ´Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸

- [ ] **ĞĞ´Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ = Ğ¾Ğ´Ğ½Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°?**
  - Ğ•ÑĞ»Ğ¸ Ğ´ĞµĞ»Ğ°ĞµÑ‚ 2+ Ğ²ĞµÑ‰Ğ¸ â†’ Ñ€Ğ°Ğ·Ğ±ĞµĞ¹

- [ ] **Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ´ĞµĞ»ĞµĞ½Ğ° Ğ¾Ñ‚ Ğ‘Ğ”?**
  - CRUD Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ñ Ğ‘Ğ”
  - Ğ Ğ°ÑÑ‡ĞµÑ‚Ñ‹ Ğ² helpers

- [ ] **Ğ¢ĞµĞºÑÑ‚Ñ‹ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ?**
  - Ğ’ÑĞµ Ğ¿ÑƒÑˆĞ¸ Ğ² *_messages.py
  - ĞĞµ Ñ…Ğ°Ñ€Ğ´ĞºĞ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ² handlers

- [ ] **ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğµ?**
  - `calculate_bonus()` âœ…
  - `func1()` âŒ

- [ ] **Ğ¢Ğ¸Ğ¿Ñ‹ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ñ‹?**
  ```python
  async def add_balance(session: AsyncSession, user_id: int, amount: int) -> bool:
  ```

- [ ] **Docstrings ĞµÑÑ‚ÑŒ?**
  ```python
  async def validate_card(card: str) -> tuple[bool, str]:
      """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ±Ğ°Ğ½ĞºĞ¾Ğ²ÑĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹
      
      Args:
          card: ĞĞ¾Ğ¼ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ñ‹ (16 Ñ†Ğ¸Ñ„Ñ€)
          
      Returns:
          (is_valid, error_message)
      """
  ```

- [ ] **ĞĞµÑ‚ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ´Ğ°?**
  - Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµÑˆÑŒ 2+ Ñ€Ğ°Ğ·Ğ° â†’ Ğ²Ñ‹Ğ½ĞµÑĞ¸ Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ

- [ ] **Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ñ‹?**
  ```python
  # Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸
  import logging
  from datetime import datetime
  
  # Ğ¡Ñ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğµ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸
  from aiogram import Router, F
  from sqlalchemy import select
  
  # Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹
  from database.crud import get_user_by_id
  from utils.referral_helpers import calculate_bonus
  ```

---

## ğŸ“ ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« Ğ Ğ•Ğ¤ĞĞšĞ¢ĞĞ Ğ˜ĞĞ“Ğ

### âŒ ĞŸĞ›ĞĞ¥Ğ (Ğ²ÑÑ‘ Ğ² ĞºÑƒÑ‡Ğµ):
```python
async def process_reward(callback, referee_id):
    # 150 ÑÑ‚Ñ€Ğ¾Ğº ĞºĞ¾Ğ´Ğ°...
    # SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
    # Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
    # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞºÑÑ‚Ğ°
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
    # Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
```

### âœ… Ğ¥ĞĞ ĞĞ¨Ğ (Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¾):
```python
# handlers/user_handlers.py
async def process_reward(callback, referee_id):
    data = await fetch_reward_data(callback.from_user.id, referee_id)
    result = await execute_reward_logic(data)
    await send_reward_response(callback, result)

# utils/referral_helpers.py
async def fetch_reward_data(referrer_tg_id, referee_id):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹"""
    # Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ‘Ğ” Ñ‡ĞµÑ€ĞµĞ· CRUD
    pass

async def execute_reward_logic(data):
    """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ"""
    # Ğ Ğ°ÑÑ‡ĞµÑ‚Ñ‹, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    pass

# utils/referral_messages.py
def format_reward_message(result):
    """Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ğµ"""
    # Ğ¢ĞµĞºÑÑ‚
    pass
```

---

## ğŸ¯ Ğ˜Ğ¢ĞĞ“Ğ: ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ Ğ Ğ•Ğ¤Ğ•Ğ ĞĞ›Ğ¬ĞĞĞ™ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«

1. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ 2 Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ°:**
   - `utils/referral_helpers.py` - Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
   - `utils/referral_messages.py` - Ğ²ÑĞµ Ñ‚ĞµĞºÑÑ‚Ñ‹

2. **Ğ’ CRUD Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ SQL:**
   - ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ¾Ğ²
   - ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
   - Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ‘Ğ” Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

3. **Ğ’ handlers Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ routing:**
   - ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ callback_data
   - Ğ’Ñ‹Ğ·Ğ¾Ğ² helpers/crud
   - ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°

4. **Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğµ:**
   - < 50 ÑÑ‚Ñ€Ğ¾Ğº
   - ĞĞ´Ğ½Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°
   - ĞŸĞ¾Ğ½ÑÑ‚Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ

5. **Ğ’ÑÑ‘ Ñ‚Ğ¸Ğ¿Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾:**
   - Type hints Ğ²ĞµĞ·Ğ´Ğµ
   - Docstrings Ğ²ĞµĞ·Ğ´Ğµ

6. **ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
   - ĞĞµ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹ ĞºĞ¾Ğ´
   - Ğ’Ñ‹Ğ½ĞµÑĞ¸ Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
   - DRY Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿

---

## âœ… ĞŸĞ Ğ˜ĞœĞ•ĞĞ˜Ğœ Ğ­Ğ¢Ğ Ğš ĞĞĞ¨Ğ•ĞœĞ£ TODO!

ĞĞ±Ğ½Ğ¾Ğ²Ğ»Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°! ğŸš€
