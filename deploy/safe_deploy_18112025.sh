#!/bin/bash
#
# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç 18.11.2025
# - –°–æ–∑–¥–∞–µ—Ç –±—ç–∫–∞–ø —Å –∏–º–µ–Ω–µ–º 18112025
# - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç systemd —Å–µ—Ä–≤–∏—Å
# - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
# - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å
# - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
#

set -e

BACKUP_NAME="18112025"
PROJECT_DIR="/root/home/momsclub"
BACKUP_DIR="/root/backups/momsclub_backup_${BACKUP_NAME}"

echo "=============================================="
echo "üöÄ –ë–ï–ó–û–ü–ê–°–ù–´–ô –î–ï–ü–õ–û–ô - 18.11.2025"
echo "=============================================="
echo ""

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
echo "üìä –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."
cd "$PROJECT_DIR" || { echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $PROJECT_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"; exit 1; }

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
SERVICE_NAME="telegram-bot"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if ! systemctl list-units --type=service | grep -q "telegram-bot.service"; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–∏—Å telegram-bot –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ systemd"
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
    systemctl list-units --type=service | grep -i bot || echo "–ù–µ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ —Å 'bot' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏"
    exit 1
fi

echo "‚úÖ –ù–∞–π–¥–µ–Ω —Å–µ—Ä–≤–∏—Å: $SERVICE_NAME"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å $SERVICE_NAME —Ä–∞–±–æ—Ç–∞–µ—Ç"
    systemctl status "$SERVICE_NAME" --no-pager -l | head -10
else
    echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å $SERVICE_NAME –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

echo ""
echo "–¢–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:"
ls -lh bot.py database/config.py utils/rate_limiter.py 2>/dev/null || echo "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
echo ""

# –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
echo "=============================================="
echo "üíæ –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ $BACKUP_NAME"
echo "=============================================="

if [ -d "$BACKUP_DIR" ]; then
    echo "‚ö†Ô∏è  –ë—ç–∫–∞–ø $BACKUP_NAME —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    echo "–•–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å? (yes/no)"
    read -r response
    if [ "$response" != "yes" ]; then
        echo "‚ùå –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω"
        exit 1
    fi
    rm -rf "$BACKUP_DIR"
fi

mkdir -p "$BACKUP_DIR"
echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $BACKUP_DIR"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–¥ –±—ç–∫–∞–ø–æ–º
echo ""
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å $SERVICE_NAME..."
systemctl stop "$SERVICE_NAME"
sleep 2

if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å"
    exit 1
fi
echo "‚úÖ –°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
echo ""
echo "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –±—ç–∫–∞–ø..."

# –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
cp -r bot.py "$BACKUP_DIR/" 2>/dev/null || echo "‚ö†Ô∏è  bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
cp -r config.py "$BACKUP_DIR/" 2>/dev/null || echo "‚ö†Ô∏è  config.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
cp -r requirements.txt "$BACKUP_DIR/" 2>/dev/null || echo "‚ö†Ô∏è  requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –ö–æ–ø–∏—Ä—É–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
for dir in handlers database utils loyalty media deploy; do
    if [ -d "$dir" ]; then
        cp -r "$dir" "$BACKUP_DIR/"
        echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $dir"
    else
        echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $dir –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
done

# –ö–æ–ø–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
if [ -f "momsclub.db" ]; then
    cp momsclub.db "$BACKUP_DIR/"
    echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: momsclub.db"
else
    echo "‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö momsclub.db –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

# –ö–æ–ø–∏—Ä—É–µ–º .env (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -f ".env" ]; then
    cp .env "$BACKUP_DIR/.env.backup"
    echo "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª .env"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞
BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
echo ""
echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üìä –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞: $BACKUP_SIZE"
echo "üìÅ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: $BACKUP_DIR"

# –®–∞–≥ 3: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–∞—Ö
echo ""
echo "=============================================="
echo "üì• –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤"
echo "=============================================="
echo ""
echo "–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:"
echo "  1. loyalty/levels.py (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω race condition)"
echo "  2. loyalty/service.py (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω race condition)"
echo "  3. database/config.py (expire_on_commit=True)"
echo "  4. utils/rate_limiter.py (–ù–û–í–´–ô - –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞)"
echo "  5. utils/validators.py (–ù–û–í–´–ô - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö)"
echo "  6. bot.py (–¥–æ–±–∞–≤–ª–µ–Ω rate limiting middleware)"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
echo ""
echo "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–µ–ø–ª–æ–π? (yes/no)"
read -r response

if [ "$response" != "yes" ]; then
    echo ""
    echo "‚è∏Ô∏è  –î–µ–ø–ª–æ–π –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞—Ç–Ω–æ..."
    systemctl start "$SERVICE_NAME"
    echo "‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
    exit 0
fi

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
echo ""
echo "=============================================="
echo "üîç –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤"
echo "=============================================="

MISSING_FILES=0

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤..."

if [ -f "utils/rate_limiter.py" ]; then
    echo "‚úÖ utils/rate_limiter.py –Ω–∞–π–¥–µ–Ω"
else
    echo "‚ùå utils/rate_limiter.py –ù–ï –ù–ê–ô–î–ï–ù!"
    MISSING_FILES=$((MISSING_FILES + 1))
fi

if [ -f "utils/validators.py" ]; then
    echo "‚úÖ utils/validators.py –Ω–∞–π–¥–µ–Ω"
else
    echo "‚ùå utils/validators.py –ù–ï –ù–ê–ô–î–ï–ù!"
    MISSING_FILES=$((MISSING_FILES + 1))
fi

if [ $MISSING_FILES -gt 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ –≤—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã ($MISSING_FILES –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)"
    echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é..."
    systemctl start "$SERVICE_NAME"
    exit 1
fi

echo ""
echo "‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ"

# –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
echo ""
echo "=============================================="
echo "üöÄ –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞"
echo "=============================================="

systemctl start "$SERVICE_NAME"
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å–∫
if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å $SERVICE_NAME —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
else
    echo "‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    echo ""
    echo "–õ–æ–≥–∏ –æ—à–∏–±–æ–∫:"
    journalctl -u "$SERVICE_NAME" -n 20 --no-pager
    echo ""
    echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –±—ç–∫–∞–ø—É..."
    
    # –û—Ç–∫–∞—Ç
    cp -r "$BACKUP_DIR"/* "$PROJECT_DIR/"
    systemctl start "$SERVICE_NAME"
    
    echo "‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω, —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞"
    exit 1
fi

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
echo ""
echo "=============================================="
echo "‚úÖ –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏"
echo "=============================================="

echo ""
echo "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
systemctl status "$SERVICE_NAME" --no-pager -l | head -15

echo ""
echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (5 —Å–µ–∫—É–Ω–¥):"
timeout 5 journalctl -u "$SERVICE_NAME" -f --no-pager || true

echo ""
echo "=============================================="
echo "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
echo "=============================================="
echo ""
echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ø–ª–æ–µ:"
echo "  ‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_DIR"
echo "  ‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω: $SERVICE_NAME"
echo "  ‚úÖ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
echo ""
echo "üìù –ß—Ç–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:"
echo "  1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω race condition –≤ —Å–∏—Å—Ç–µ–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
echo "  2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω expire_on_commit –≤ –ë–î"
echo "  3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ (rate limiting)"
echo "  4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
echo ""
echo "üîç –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "  journalctl -u $SERVICE_NAME -f"
echo ""
echo "üîô –î–ª—è –æ—Ç–∫–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "  cd $PROJECT_DIR/deploy"
echo "  sudo ./rollback.sh $BACKUP_NAME"
echo ""
