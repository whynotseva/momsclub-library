# Анализ платежной системы Mom's Club

## Общая архитектура системы

### Основные компоненты:
1. **Telegram Bot** (`bot.py`) - основной интерфейс взаимодействия с пользователями
2. **База данных** (`database/`) - хранение пользователей, подписок, платежей
3. **Платежная система** (`utils/payment.py`) - интеграция с ЮКассой
4. **Вебхуки** (`handlers/webhook_handlers.py`) - обработка уведомлений от ЮКассы
5. **Пользовательские обработчики** (`handlers/user_handlers.py`) - логика команд бота

---

## Путь клиента от начала до конца

### 1. Первый контакт с ботом

**Точка входа:** Пользователь нажимает кнопку "Присоединиться к Mom's Club" или вводит `/start`

**Процесс:**
1. Бот получает информацию о пользователе (ID, username, first_name, last_name)
2. Создается/обновляется запись в таблице `users`
3. Отправляется приветственное сообщение с описанием клуба
4. Показывается основная клавиатура с кнопками

### 2. Регистрация и сбор информации

**Этапы:**
1. **Приветствие** - отправка welcome.jpg и текста с описанием клуба
2. **Сбор телефона** (опционально) - FSM состояние `PhoneStates.waiting_for_phone`
3. **Сбор даты рождения** (опционально) - FSM состояние `BirthdayStates.waiting_for_birthday`
4. **Ввод промокода** (опционально) - FSM состояние `PromoCodeStates.waiting_for_promo_code`

### 3. Выбор тарифа и оплата

**Доступные тарифы:**
- 1 месяц: 990 ₽ (30 дней)
- 2 месяца: 1790 ₽ (60 дней) 
- 3 месяца: 2490 ₽ (90 дней)

**Процесс оплаты:**
1. Пользователь выбирает тариф
2. Бот вызывает `create_payment_link()` из `utils/payment.py`
3. Создается платеж в ЮКассе через API
4. Возвращается ссылка на оплату
5. Пользователь перенаправляется на страницу ЮКассы

### 4. Обработка платежа

**Этапы обработки:**
1. **Создание платежа в ЮКассе:**
   - Генерируется уникальный `payment_id` и `payment_label`
   - Сохраняются метаданные (user_id, sub_type, days, payment_label)
   - Устанавливается `save_payment_method = True` для возможности автоплатежей

2. **Создание записи в БД:**
   - В таблице `payment_logs` создается запись со статусом "pending"
   - Сохраняются все детали платежа

3. **Ожидание вебхука от ЮКассы:**
   - При успешной оплате приходит `payment.succeeded`
   - При отмене - `payment.canceled`

### 5. Активация подписки

**При успешном платеже:**
1. Вызывается `process_successful_payment()`
2. Проверяется наличие активной подписки:
   - **Если есть активная подписка:** продлевается через `extend_subscription()`
   - **Если нет активной подписки:** создается новая через `create_subscription()`

3. **Параметры подписки:**
   - `renewal_price` = цене текущего платежа
   - `renewal_duration_days` = длительности текущего платежа
   - `is_active = True`

4. **Обработка рефералов:**
   - Если пользователь пришел по реферальной ссылке
   - И это его первый платеж
   - Рефереру начисляется 7 дней бонуса

### 6. Уведомления

**После успешной оплаты:**
1. **Пользователю:** уведомление об успешной оплате с датой окончания подписки
2. **Администраторам:** уведомление о новом платеже
3. **Добавление в канал:** пользователь получает доступ к закрытому каналу

---

## Хранение данных в базе данных

### Основные таблицы:

#### 1. `users` - Пользователи
```sql
- id (PRIMARY KEY)
- telegram_id (уникальный ID в Telegram)
- username, first_name, last_name
- phone (опционально)
- birthday (дата рождения)
- birthday_gift_year (год последнего подарка на ДР)
- yookassa_payment_method_id (для автоплатежей)
- is_recurring_active (включено ли автопродление)
- reminder_sent (отправлено ли напоминание)
- is_blocked (заблокировал ли бот)
- referrer_id (ID пригласившего пользователя)
- referral_code (уникальный код для приглашений)
```

#### 2. `subscriptions` - Подписки
```sql
- id (PRIMARY KEY)
- user_id (ссылка на пользователя)
- start_date, end_date
- price (цена подписки в копейках)
- is_active (активна ли подписка)
- payment_id (ID платежа)
- renewal_price (цена автопродления)
- renewal_duration_days (длительность автопродления)
- autopayment_fail_count (счетчик неудачных автоплатежей)
- next_retry_attempt_at (дата следующей попытки автоплатежа)
```

#### 3. `payment_logs` - Логи платежей
```sql
- id (PRIMARY KEY)
- user_id (ссылка на пользователя)
- subscription_id (ссылка на подписку)
- amount (сумма в копейках)
- status (success, pending, failed, etc.)
- payment_method (youkassa_autopay, etc.)
- transaction_id (ID транзакции ЮКассы)
- payment_label (метка платежа)
- details (дополнительная информация)
- days (количество дней подписки)
- is_confirmed (подтвержден ли платеж)
```

#### 4. `promo_codes` - Промокоды
```sql
- id (PRIMARY KEY)
- code (уникальный код)
- discount_type (days/percent)
- value (количество дней/процент)
- max_uses, current_uses
- is_active, expiry_date
```

#### 5. `user_promo_codes` - Использование промокодов
```sql
- user_id, promo_code_id, used_at
```

---

## Автопродление подписок

### Настройка автопродления:

**Конфигурация в `config.py`:**
```python
SUBSCRIPTION_RENEWAL_SETTINGS = {
    "check_interval_hours": 2,      # Проверка каждые 2 часа
    "renewal_window_days": 1,       # За 1 день до окончания
    "max_autopayment_fails": 3,     # Макс. 3 неудачные попытки
    "retry_schedule_days": [1, 3, 5] # Повтор через 1, 3, 5 дней
}
```

### Процесс автопродления:

1. **Фоновая задача** `process_subscription_auto_renewal()`:
   - Запускается каждые 2 часа
   - Ищет подписки, заканчивающиеся в ближайшие 1 день
   - Проверяет условия для автопродления

2. **Условия для автопродления:**
   - `is_recurring_active = True`
   - Есть `yookassa_payment_method_id`
   - Подписка активна
   - Не было недавних неудачных попыток

3. **Процесс автоплатежа:**
   - Создается запись в `payment_logs` со статусом "pending_autorenewal"
   - Вызывается `create_autopayment()` из `utils/payment.py`
   - Отправляется запрос в ЮКассу на автоплатеж
   - Ожидается вебхук от ЮКассы

4. **Обработка результатов:**
   - **Успех:** подписка продлевается, счетчик неудач сбрасывается
   - **Неудача:** увеличивается счетчик, планируется повторная попытка
   - **3 неудачи подряд:** автопродление отключается

### Отключение автопродления:

**Причины отключения:**
1. 3 последовательные неудачные попытки
2. Некорректные параметры автопродления
3. Пользователь вручную отключает
4. Администратор отключает

**Процесс отключения:**
1. `is_recurring_active = False`
2. `yookassa_payment_method_id = None`
3. Уведомление пользователю

---

## Возможные варианты событий

### 1. Успешный путь клиента:

```
Старт бота → Приветствие → Выбор тарифа → Оплата → Успешный платеж → 
Активация подписки → Уведомление → Доступ к каналу → Автопродление включено
```

### 2. Проблемы с оплатой:

```
Выбор тарифа → Оплата → Неудачная оплата → 
Вебхук payment.canceled → Уведомление пользователю → 
Предложение повторить оплату
```

### 3. Автопродление с проблемами:

```
Подписка заканчивается → Попытка автоплатежа №1 → Неудача → 
Ожидание 1 день → Попытка №2 → Неудача → 
Ожидание 3 дня → Попытка №3 → Неудача → 
Отключение автопродления → Уведомление пользователю
```

### 4. Реферальная система:

```
Пользователь A получает реферальную ссылку → 
Пользователь B переходит по ссылке → Регистрация B → 
Первый платеж B → Начисление 7 дней A → Уведомление A
```

### 5. День рождения:

```
Пользователь указал дату рождения → Наступает день рождения → 
Автоматическое начисление 7 дней → Уведомление в канал и лично
```

### 6. Продление подписки:

```
Активная подписка → Выбор продления → Оплата → 
Продление существующей подписки → Обновление параметров автопродления
```

---

## Мониторинг и уведомления

### Системные уведомления:

1. **Администраторам:**
   - Новые платежи
   - Проблемы с автопродлением
   - Ошибки в системе

2. **Пользователям:**
   - Успешная оплата
   - Проблемы с автопродлением
   - Напоминания об оплате
   - День рождения
   - Реферальные бонусы

### Логирование:

**Отдельные логгеры:**
- `payment_logger` - платежи
- `autorenewal_logger` - автопродление
- `birthday_logger` - дни рождения
- `reminder_logger` - напоминания

**Файлы логов:**
- `bot.log` - основной лог
- `payment_logs.log` - платежи
- `birthday_logs.log` - дни рождения

---

## Безопасность и надежность

### Меры безопасности:

1. **Проверка подписей вебхуков** от ЮКассы
2. **Валидация платежей** по сумме и метаданным
3. **Защита от повторной обработки** платежей
4. **CORS защита** для вебхуков
5. **Идемпотентность** платежей

### Обработка ошибок:

1. **Сетевое взаимодействие** с ЮКассой
2. **База данных** - транзакции и откаты
3. **Telegram API** - повторные попытки отправки
4. **Временные режимы** для технического обслуживания

---

## Режимы работы

### 1. Обычный режим:
- Полная функциональность
- Все платежи активны
- Автопродление работает

### 2. Временный режим оплаты:
- `TEMPORARY_PAYMENT_MODE = True`
- Платежи перенаправляются к администратору
- Отправка уведомлений администратору

### 3. Техническое обслуживание:
- `MAINTENANCE_MODE = True`
- `DISABLE_PAYMENTS = True`
- Отключение платежей и автопродления

---

## Расширение системы

### Возможные улучшения:

1. **Дополнительные платежные системы** (Stripe, PayPal)
2. **Промокоды** с различными типами скидок
3. **Семейные подписки** (несколько пользователей)
4. **Подарочные подписки**
5. **Аналитика платежей** и поведения пользователей
6. **Интеграция с CRM**
7. **Многоуровневая реферальная система**

### Текущие ограничения:

1. **Только ЮКасса** как платежная система
2. **Фиксированные тарифы** (нельзя создать кастомный)
3. **Один активный тариф** на пользователя
4. **Отсутствие триального периода**

---

*Анализ составлен на основе кода системы Mom's Club по состоянию на 28 августа 2025 г.*</content>
<parameter name="filePath">/Users/nikitasahanin/Desktop/momsclub/payment_system_analysis.md
